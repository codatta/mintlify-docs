name: Auto Translate (Push to New Branch)

on:
  push:
    branches-ignore:
      - main

jobs:
  translate:
    if: "!contains(github.ref_name, 'auto-translate')"
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # 1️⃣ 检出触发的源分支
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      # 2️⃣ Node 环境
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3️⃣ 安装依赖
      - name: Install deps
        run: |
          npm init -y
          npm install openai fs-extra

      # 4️⃣ 执行翻译（生成 cn/ ko/ 文件）
      - name: Run translation
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: node translate.js
        timeout-minutes: 60

      # 5️⃣ 创建【带时间戳】的翻译分支并 push
      - name: Push translated files
        run: |
          # 时间戳（UTC，保证稳定）
          TS=$(date -u '+%Y%m%d-%H%M%S')

          SRC_BRANCH="${GITHUB_REF_NAME}"
          TRANS_BRANCH="${SRC_BRANCH}-auto-translate-${TS}"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # 新建翻译分支（每次都是新的）
          git checkout -b "$TRANS_BRANCH"

          # 确保目录存在（防止 glob 报错）
          mkdir -p cn/changelog
          mkdir -p ko/changelog

          # 只 add 翻译文件 
          git add cn/** ko/**

          # 没变化就不提交
          git diff --cached --quiet || git commit -m "chore: auto translate (${TS})"

          # 推送新分支
          git push origin "$TRANS_BRANCH"